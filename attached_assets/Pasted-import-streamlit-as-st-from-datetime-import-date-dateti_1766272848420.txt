import streamlit as st
from datetime import date, datetime
import os
import database as db
from vaccination_guidelines import generate_vaccination_schedule


def render():
    st.markdown("""
    <style>
        h2, h3 {
            color: #1a1a1a !important;
        }

        p {
            color: #000000 !important;
        }

        /* Tabs text force black */
        button[data-baseweb="tab"] {
            color: #000000 !important;
            font-weight: 600 !important;
        }

        button[data-baseweb="tab"]:hover,
        button[data-baseweb="tab"]:active,
        button[data-baseweb="tab"]:focus {
            color: #000000 !important;
        }

        /* ---------------- Date Picker: FIX VISIBILITY ---------------- */

        .react-datepicker {
            background-color: #ffffff !important;
            border: 1px solid #dcdcdc !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.12) !important;
        }

        .react-datepicker__header {
            background-color: #f8f9fa !important;
            border-bottom: 1px solid #e0e0e0 !important;
        }

        .react-datepicker__current-month {
            color: #1a1a1a !important;
            font-weight: 700 !important;
            font-size: 1rem !important;
        }

        .react-datepicker__year-read-view,
        .react-datepicker__month-read-view {
            color: #1a1a1a !important;
            font-weight: 600 !important;
        }

        .react-datepicker__navigation-icon::before {
            border-color: #1a1a1a !important;
        }

        .react-datepicker__day-name {
            color: #444444 !important;
            font-weight: 600 !important;
        }

        .react-datepicker__day {
            color: #333333 !important;
        }

        .react-datepicker__day:hover {
            background-color: #e9ecff !important;
            color: #1a1a1a !important;
        }

        .react-datepicker__day--selected,
        .react-datepicker__day--keyboard-selected {
            background-color: #667eea !important;
            color: #ffffff !important;
        }

        .react-datepicker__day--today {
            font-weight: 700 !important;
            color: #667eea !important;
        }
    </style>
    """, unsafe_allow_html=True)

    st.markdown('<h1 style="color:#667eea;margin-top:0;">Settings</h1>', unsafe_allow_html=True)
    st.markdown('<p>Manage your child profiles, notification preferences, and account settings</p>', unsafe_allow_html=True)

    tab1, tab2, tab3, tab4 = st.tabs(["Child Profiles", "Notifications", "About", "Account"])

    with tab1:
        render_child_profiles()

    with tab2:
        render_notification_settings()

    with tab3:
        render_about()

    with tab4:
        render_account()


def render_child_profiles():
    st.subheader("Manage Child Profiles")

    if st.button("Add New Child Profile", type="primary"):
        st.session_state.show_add_child = True

    if st.session_state.get("show_add_child", False):
        render_add_child_form()

    user_id = st.session_state.get("user_id")
    children = db.get_all_children(user_id=user_id)

    if children:
        st.subheader("Existing Profiles")
        for child in children:
            render_child_profile_card(child)
    else:
        st.info("No child profiles yet. Add a child to get started.")


def render_add_child_form():
    with st.form("add_child_form"):
        st.subheader("Add New Child")

        col1, col2 = st.columns(2)
        with col1:
            name = st.text_input("Child's Name")
        with col2:
            dob = st.date_input(
                "Date of Birth",
                value=date.today(),
                max_value=date.today(),
                min_value=date(2000, 1, 1)
            )

        col1, col2 = st.columns(2)
        with col1:
            guideline = st.selectbox("Vaccination Guideline", ["India (UIP)", "WHO"])
        with col2:
            gender = st.selectbox("Gender", ["Not specified", "Male", "Female", "Other"])

        col1, col2 = st.columns(2)
        with col1:
            blood_group = st.selectbox(
                "Blood Group (Optional)",
                ["Not specified", "A+", "A-", "B+", "B-", "AB+", "AB-", "O+", "O-"]
            )
        with col2:
            allergies = st.text_input("Known Allergies (Optional)")

        received = st.text_area(
            "Already Received Vaccines (Optional)",
            placeholder="BCG, OPV, Hepatitis B"
        )

        col1, col2 = st.columns(2)
        with col1:
            submitted = st.form_submit_button("Add Child", type="primary")
        with col2:
            cancel = st.form_submit_button("Cancel")

        if cancel:
            st.session_state.show_add_child = False
            st.rerun()

        if submitted:
            if not name:
                st.error("Child name is required")
                return

            user_id = st.session_state.get("user_id")
            child_id = db.add_child(
                name=name,
                date_of_birth=dob.isoformat(),
                country_guideline=guideline,
                user_id=user_id,
                gender=None if gender == "Not specified" else gender,
                blood_group=None if blood_group == "Not specified" else blood_group,
                allergies=allergies or None
            )

            schedule = generate_vaccination_schedule(dob, guideline)
            received_list = [r.strip().lower() for r in received.split(",")] if received else []

            for v in schedule:
                is_done = any(r in v["vaccine_name"].lower() for r in received_list)
                vid = db.add_vaccination(
                    child_id=child_id,
                    vaccine_name=v["vaccine_name"],
                    vaccine_code=v["vaccine_code"],
                    due_date=v["due_date"].isoformat(),
                    status="completed" if is_done else "pending"
                )
                if is_done:
                    db.update_vaccination_status(
                        vid, "completed", date.today().isoformat()
                    )

            st.session_state.show_add_child = False
            st.success("Child profile created successfully")
            st.rerun()


def render_child_profile_card(child):
    dob = date.fromisoformat(child["date_of_birth"])
    from vaccination_guidelines import get_age_string
    age = get_age_string(dob)

    with st.expander(f"{child['name']} - {age}"):
        st.write(f"Date of Birth: {dob.strftime('%B %d, %Y')}")
        st.write(f"Guideline: {child['country_guideline']}")
        st.write(f"Gender: {child.get('gender', 'Not specified')}")
        st.write(f"Blood Group: {child.get('blood_group', 'Not specified')}")
        st.write(f"Allergies: {child.get('allergies', 'None')}")

        if st.button("Delete Profile", key=f"delete_{child['id']}"):
            db.delete_child(child["id"])
            st.success("Profile deleted")
            st.rerun()


def render_notification_settings():
    st.subheader("Notification Preferences")
    st.info("Notification settings configuration coming soon.")


def render_about():
    st.subheader("About")
    st.markdown("Smart Child Vaccination & Health Assistant")


def render_account():
    st.subheader("Account")
    if st.button("Logout"):
        st.session_state.logged_in = False
        st.session_state.current_page = "Home"
        st.rerun()
